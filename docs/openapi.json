{
  "openapi": "3.1.0",
  "info": {
    "title": "Magpipe API",
    "description": "Complete API for AI phone agents, calls, SMS, and chat",
    "version": "1.0.0",
    "contact": {
      "email": "support@magpipe.ai"
    }
  },
  "servers": [
    {
      "url": "https://mtxbiyilvgwhbdptysex.supabase.co/functions/v1",
      "description": "Production API"
    }
  ],
  "security": [
    {
      "bearerAuth": []
    }
  ],
  "components": {
    "securitySchemes": {
      "bearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT",
        "description": "Your Magpipe access token from the dashboard"
      }
    },
    "schemas": {
      "Error": {
        "type": "object",
        "properties": {
          "error": {
            "type": "object",
            "properties": {
              "code": { "type": "string", "description": "Error code for programmatic handling" },
              "message": { "type": "string", "description": "Human-readable error message" }
            }
          }
        }
      },
      "Agent": {
        "type": "object",
        "properties": {
          "id": { "type": "string", "format": "uuid", "description": "Unique agent identifier" },
          "user_id": { "type": "string", "format": "uuid", "description": "Owner user ID" },
          "name": { "type": "string", "description": "Agent display name", "maxLength": 100 },
          "greeting": { "type": "string", "description": "Message spoken when answering calls", "maxLength": 500 },
          "system_prompt": { "type": "string", "description": "Instructions defining agent behavior", "maxLength": 10000 },
          "voice_id": { "type": "string", "description": "Voice identifier for TTS" },
          "voice_provider": { "type": "string", "enum": ["openai", "elevenlabs"], "description": "TTS provider" },
          "voice_speed": { "type": "number", "minimum": 0.5, "maximum": 2.0, "default": 1.0 },
          "language": { "type": "string", "default": "en-US" },
          "agent_type": { "type": "string", "enum": ["inbound", "outbound", "both"], "default": "inbound" },
          "max_call_duration": { "type": "integer", "minimum": 60, "maximum": 3600, "default": 1800 },
          "end_call_phrases": { "type": "array", "items": { "type": "string" } },
          "transfer_number": { "type": "string", "description": "Number for call transfers" },
          "is_active": { "type": "boolean", "default": true },
          "is_default": { "type": "boolean", "default": false },
          "organization_name": { "type": "string" },
          "owner_name": { "type": "string" },
          "agent_role": { "type": "string" },
          "created_at": { "type": "string", "format": "date-time" },
          "updated_at": { "type": "string", "format": "date-time" }
        }
      },
      "PhoneNumber": {
        "type": "object",
        "properties": {
          "id": { "type": "string", "format": "uuid" },
          "user_id": { "type": "string", "format": "uuid" },
          "phone_number": { "type": "string", "description": "E.164 format phone number" },
          "friendly_name": { "type": "string" },
          "agent_id": { "type": "string", "format": "uuid" },
          "capabilities": {
            "type": "object",
            "properties": {
              "voice": { "type": "boolean" },
              "sms": { "type": "boolean" },
              "mms": { "type": "boolean" }
            }
          },
          "is_active": { "type": "boolean" },
          "provider": { "type": "string", "enum": ["signalwire", "twilio"] },
          "created_at": { "type": "string", "format": "date-time" }
        }
      },
      "Call": {
        "type": "object",
        "properties": {
          "id": { "type": "string", "format": "uuid" },
          "user_id": { "type": "string", "format": "uuid" },
          "agent_id": { "type": "string", "format": "uuid" },
          "from_number": { "type": "string" },
          "to_number": { "type": "string" },
          "direction": { "type": "string", "enum": ["inbound", "outbound"] },
          "status": { "type": "string", "enum": ["initiated", "ringing", "in-progress", "completed", "busy", "no-answer", "failed", "canceled"] },
          "duration": { "type": "integer", "description": "Duration in seconds" },
          "recording_url": { "type": "string", "format": "uri" },
          "transcript": { "type": "string" },
          "transcript_segments": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "speaker": { "type": "string", "enum": ["agent", "caller"] },
                "text": { "type": "string" },
                "start_time": { "type": "number" },
                "end_time": { "type": "number" }
              }
            }
          },
          "sentiment": { "type": "string", "enum": ["positive", "neutral", "negative"] },
          "call_summary": { "type": "string" },
          "metadata": { "type": "object", "additionalProperties": true },
          "started_at": { "type": "string", "format": "date-time" },
          "ended_at": { "type": "string", "format": "date-time" },
          "created_at": { "type": "string", "format": "date-time" }
        }
      },
      "Message": {
        "type": "object",
        "properties": {
          "id": { "type": "string", "format": "uuid" },
          "thread_id": { "type": "string", "format": "uuid" },
          "user_id": { "type": "string", "format": "uuid" },
          "from_number": { "type": "string" },
          "to_number": { "type": "string" },
          "body": { "type": "string" },
          "direction": { "type": "string", "enum": ["inbound", "outbound"] },
          "status": { "type": "string", "enum": ["queued", "sent", "delivered", "undelivered", "failed"] },
          "is_ai_generated": { "type": "boolean" },
          "media_urls": { "type": "array", "items": { "type": "string", "format": "uri" } },
          "segments": { "type": "integer" },
          "error_code": { "type": "string" },
          "error_message": { "type": "string" },
          "created_at": { "type": "string", "format": "date-time" }
        }
      },
      "ChatSession": {
        "type": "object",
        "properties": {
          "id": { "type": "string", "format": "uuid" },
          "widget_id": { "type": "string", "format": "uuid" },
          "visitor_id": { "type": "string" },
          "visitor_name": { "type": "string" },
          "visitor_email": { "type": "string", "format": "email" },
          "status": { "type": "string", "enum": ["active", "closed"] },
          "page_url": { "type": "string" },
          "browser_info": { "type": "object" },
          "last_message_at": { "type": "string", "format": "date-time" },
          "created_at": { "type": "string", "format": "date-time" }
        }
      },
      "ChatWidget": {
        "type": "object",
        "properties": {
          "id": { "type": "string", "format": "uuid" },
          "user_id": { "type": "string", "format": "uuid" },
          "agent_id": { "type": "string", "format": "uuid" },
          "widget_key": { "type": "string" },
          "name": { "type": "string" },
          "agent_name": { "type": "string" },
          "primary_color": { "type": "string" },
          "position": { "type": "string", "enum": ["bottom-right", "bottom-left"] },
          "welcome_message": { "type": "string" },
          "offline_message": { "type": "string" },
          "collect_visitor_name": { "type": "boolean" },
          "collect_visitor_email": { "type": "boolean" },
          "is_active": { "type": "boolean" },
          "allowed_domains": { "type": "array", "items": { "type": "string" } },
          "created_at": { "type": "string", "format": "date-time" }
        }
      },
      "KnowledgeSource": {
        "type": "object",
        "properties": {
          "id": { "type": "string", "format": "uuid" },
          "user_id": { "type": "string", "format": "uuid" },
          "url": { "type": "string", "format": "uri" },
          "title": { "type": "string" },
          "description": { "type": "string" },
          "sync_period": { "type": "string", "enum": ["24h", "7d", "1mo", "3mo"] },
          "sync_status": { "type": "string", "enum": ["pending", "syncing", "completed", "failed"] },
          "chunk_count": { "type": "integer" },
          "last_synced_at": { "type": "string", "format": "date-time" },
          "next_sync_at": { "type": "string", "format": "date-time" },
          "created_at": { "type": "string", "format": "date-time" }
        }
      },
      "Contact": {
        "type": "object",
        "properties": {
          "id": { "type": "string", "format": "uuid" },
          "user_id": { "type": "string", "format": "uuid" },
          "name": { "type": "string" },
          "phone_number": { "type": "string" },
          "email": { "type": "string", "format": "email" },
          "company": { "type": "string" },
          "notes": { "type": "string" },
          "avatar_url": { "type": "string", "format": "uri" },
          "tags": { "type": "array", "items": { "type": "string" } },
          "metadata": { "type": "object", "additionalProperties": true },
          "created_at": { "type": "string", "format": "date-time" },
          "updated_at": { "type": "string", "format": "date-time" }
        }
      },
      "VoiceClone": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "name": { "type": "string" },
          "description": { "type": "string" },
          "preview_url": { "type": "string", "format": "uri" },
          "provider": { "type": "string", "enum": ["elevenlabs"] },
          "created_at": { "type": "string", "format": "date-time" }
        }
      }
    }
  },
  "paths": {
    "/initiate-bridged-call": {
      "post": {
        "operationId": "createPhoneCall",
        "summary": "Create Phone Call",
        "description": "Initiate an outbound phone call with an AI agent. The agent assigned to the caller_id number will handle the conversation.",
        "tags": ["Calls"],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["phone_number", "caller_id"],
                "properties": {
                  "phone_number": {
                    "type": "string",
                    "description": "Destination phone number in E.164 format",
                    "example": "+14155551234",
                    "pattern": "^\\+[1-9]\\d{1,14}$"
                  },
                  "caller_id": {
                    "type": "string",
                    "description": "Your Magpipe phone number to use as caller ID (agent assigned to this number handles the call)",
                    "example": "+16045551234"
                  },
                  "purpose": {
                    "type": "string",
                    "description": "Purpose of the call (provided to the agent as context)"
                  },
                  "goal": {
                    "type": "string",
                    "description": "Goal of the call (provided to the agent as context)"
                  },
                  "template_id": {
                    "type": "string",
                    "format": "uuid",
                    "description": "Optional call template ID"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Call initiated successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": { "type": "boolean", "example": true },
                    "call_sid": { "type": "string", "description": "SignalWire call SID" },
                    "call_record_id": { "type": "string", "format": "uuid", "description": "Internal call record ID" },
                    "status": { "type": "string", "example": "queued" }
                  }
                }
              }
            }
          },
          "400": { "description": "Invalid request parameters", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } } },
          "401": { "description": "Unauthorized - invalid or missing token", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } } },
          "500": { "description": "Server error", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } } }
        }
      }
    },
    "/send-user-sms": {
      "post": {
        "operationId": "sendSms",
        "summary": "Send SMS Message",
        "description": "Send an SMS message from your Magpipe number.",
        "tags": ["Messages"],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["serviceNumber", "contactPhone", "message"],
                "properties": {
                  "contactPhone": {
                    "type": "string",
                    "description": "Recipient phone number in E.164 format",
                    "example": "+14155551234"
                  },
                  "serviceNumber": {
                    "type": "string",
                    "description": "Your SMS-enabled Magpipe number",
                    "example": "+16045551234"
                  },
                  "message": {
                    "type": "string",
                    "description": "Message content (max 1600 characters)",
                    "maxLength": 1600,
                    "example": "Your appointment is confirmed for tomorrow at 2pm."
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Message sent successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": { "type": "boolean" },
                    "message_id": { "type": "string", "format": "uuid" },
                    "status": { "type": "string", "enum": ["queued", "sent", "scheduled"] },
                    "segments": { "type": "integer" },
                    "from_number": { "type": "string" },
                    "to_number": { "type": "string" },
                    "created_at": { "type": "string", "format": "date-time" }
                  }
                }
              }
            }
          },
          "400": { "description": "Invalid request", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } } },
          "401": { "description": "Unauthorized", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } } },
          "422": { "description": "Number not SMS-enabled", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } } }
        }
      }
    },
    "/webhook-chat-message": {
      "post": {
        "operationId": "sendChatMessage",
        "summary": "Send Chat Message",
        "description": "Send a message to a chat widget session. Returns AI response.",
        "tags": ["Chat"],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["widgetKey", "visitorId", "message"],
                "properties": {
                  "widgetKey": {
                    "type": "string",
                    "description": "Chat widget key from your dashboard"
                  },
                  "visitorId": {
                    "type": "string",
                    "description": "Unique visitor identifier (e.g., from localStorage)"
                  },
                  "message": {
                    "type": "string",
                    "description": "Visitor's message content"
                  },
                  "visitorName": {
                    "type": "string",
                    "description": "Visitor's name (optional)"
                  },
                  "visitorEmail": {
                    "type": "string",
                    "format": "email",
                    "description": "Visitor's email (optional)"
                  },
                  "pageUrl": {
                    "type": "string",
                    "description": "Current page URL for context"
                  },
                  "requestGreeting": {
                    "type": "boolean",
                    "description": "Request initial greeting message (message not required if true)"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Message processed, AI response returned",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "session_id": { "type": "string", "format": "uuid" },
                    "aiResponse": { "type": "string" },
                    "aiMessageId": { "type": "string", "format": "uuid" }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/search-phone-numbers": {
      "post": {
        "operationId": "searchPhoneNumbers",
        "summary": "Search Available Numbers",
        "description": "Search for available phone numbers to provision by area code.",
        "tags": ["Phone Numbers"],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["query"],
                "properties": {
                  "query": {
                    "type": "string",
                    "description": "3-digit area code to search",
                    "example": "604"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Available numbers found",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "numbers": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "phone_number": { "type": "string" },
                          "locality": { "type": "string" },
                          "region": { "type": "string" },
                          "capabilities": {
                            "type": "object",
                            "properties": {
                              "voice": { "type": "boolean" },
                              "sms": { "type": "boolean" },
                              "mms": { "type": "boolean" }
                            }
                          }
                        }
                      }
                    },
                    "searchedQuery": { "type": "string" },
                    "usedFallback": { "type": "boolean" }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/provision-phone-number": {
      "post": {
        "operationId": "provisionPhoneNumber",
        "summary": "Provision Phone Number",
        "description": "Purchase and provision a phone number for your account.",
        "tags": ["Phone Numbers"],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["phoneNumber"],
                "properties": {
                  "phoneNumber": {
                    "type": "string",
                    "description": "Phone number to provision in E.164 format (from search results)",
                    "example": "+16045551234"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Number provisioned successfully",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/PhoneNumber" }
              }
            }
          },
          "402": { "description": "Number limit reached for plan", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } } }
        }
      }
    },
    "/knowledge-source-add": {
      "post": {
        "operationId": "addKnowledgeSource",
        "summary": "Add Knowledge Source",
        "description": "Add a URL as a knowledge source. Content is scraped, chunked, and embedded for RAG.",
        "tags": ["Knowledge Base"],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["url"],
                "properties": {
                  "url": {
                    "type": "string",
                    "format": "uri",
                    "description": "URL to scrape and add to knowledge base",
                    "maxLength": 2048
                  },
                  "sync_period": {
                    "type": "string",
                    "enum": ["24h", "7d", "1mo", "3mo"],
                    "default": "7d",
                    "description": "How often to re-sync content"
                  },
                  "auth_headers": {
                    "type": "object",
                    "description": "Optional auth headers for protected pages",
                    "additionalProperties": { "type": "string" }
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Knowledge source added",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/KnowledgeSource" }
              }
            }
          },
          "422": { "description": "Could not fetch or parse URL", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } } }
        }
      }
    },
    "/clone-voice": {
      "post": {
        "operationId": "cloneVoice",
        "summary": "Clone Voice",
        "description": "Create a custom voice clone from audio samples using ElevenLabs.",
        "tags": ["Voice"],
        "requestBody": {
          "required": true,
          "content": {
            "multipart/form-data": {
              "schema": {
                "type": "object",
                "required": ["name", "files"],
                "properties": {
                  "name": {
                    "type": "string",
                    "description": "Name for the cloned voice"
                  },
                  "description": {
                    "type": "string",
                    "description": "Description of the voice"
                  },
                  "files": {
                    "type": "array",
                    "items": {
                      "type": "string",
                      "format": "binary"
                    },
                    "description": "Audio files for voice cloning (WAV, MP3)"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Voice cloned successfully",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/VoiceClone" }
              }
            }
          }
        }
      }
    },
    "/cal-com-get-slots": {
      "post": {
        "operationId": "getCalendarSlots",
        "summary": "Get Available Calendar Slots",
        "description": "Get available appointment slots from connected Cal.com calendar.",
        "tags": ["Calendar"],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["date_from", "date_to"],
                "properties": {
                  "date_from": {
                    "type": "string",
                    "format": "date",
                    "description": "Start date for availability search"
                  },
                  "date_to": {
                    "type": "string",
                    "format": "date",
                    "description": "End date for availability search"
                  },
                  "event_type_id": {
                    "type": "integer",
                    "description": "Cal.com event type ID"
                  },
                  "timezone": {
                    "type": "string",
                    "default": "America/Los_Angeles",
                    "description": "Timezone for slots"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Available slots returned",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "slots": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "time": { "type": "string", "format": "date-time" },
                          "available": { "type": "boolean" }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/cal-com-create-booking": {
      "post": {
        "operationId": "createCalendarBooking",
        "summary": "Create Calendar Booking",
        "description": "Book an appointment on the connected Cal.com calendar.",
        "tags": ["Calendar"],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["start_time", "name", "email"],
                "properties": {
                  "event_type_id": { "type": "integer" },
                  "start_time": { "type": "string", "format": "date-time" },
                  "name": { "type": "string", "description": "Attendee name" },
                  "email": { "type": "string", "format": "email" },
                  "phone": { "type": "string" },
                  "notes": { "type": "string" },
                  "timezone": { "type": "string", "default": "America/Los_Angeles" }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Booking created",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "booking_id": { "type": "integer" },
                    "uid": { "type": "string" },
                    "start_time": { "type": "string", "format": "date-time" },
                    "end_time": { "type": "string", "format": "date-time" },
                    "meeting_url": { "type": "string", "format": "uri" }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/transfer-call": {
      "post": {
        "operationId": "transferCall",
        "summary": "Transfer Call",
        "description": "Transfer an active call to another phone number.",
        "tags": ["Calls"],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["call_id", "transfer_to"],
                "properties": {
                  "call_id": {
                    "type": "string",
                    "format": "uuid",
                    "description": "ID of the active call to transfer"
                  },
                  "transfer_to": {
                    "type": "string",
                    "description": "Phone number to transfer to (E.164)"
                  },
                  "announce": {
                    "type": "string",
                    "description": "Message to play before transfer"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Transfer initiated",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": { "type": "boolean" },
                    "transfer_call_id": { "type": "string", "format": "uuid" }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/terminate-call": {
      "post": {
        "operationId": "terminateCall",
        "summary": "End Call",
        "description": "Terminate an active call.",
        "tags": ["Calls"],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["call_sid"],
                "properties": {
                  "call_sid": {
                    "type": "string",
                    "description": "SignalWire call SID of the call to terminate"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Call terminated",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": { "type": "boolean" }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/get-signed-recording-url": {
      "post": {
        "operationId": "getRecordingUrl",
        "summary": "Get Call Recording URL",
        "description": "Get a signed URL to access a call recording.",
        "tags": ["Calls"],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["recordingUrl"],
                "properties": {
                  "recordingUrl": {
                    "type": "string",
                    "format": "uri",
                    "description": "Original recording URL to sign"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Signed URL returned",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "signedUrl": { "type": "string", "format": "uri", "description": "Signed recording URL" }
                  }
                }
              }
            }
          }
        }
      }
    }
  },
  "tags": [
    { "name": "Agents", "description": "AI agent configuration and management" },
    { "name": "Calls", "description": "Phone call management" },
    { "name": "Messages", "description": "SMS messaging" },
    { "name": "Chat", "description": "Website chat widget" },
    { "name": "Phone Numbers", "description": "Number provisioning and management" },
    { "name": "Knowledge Base", "description": "AI knowledge sources" },
    { "name": "Voice", "description": "Voice cloning and TTS" },
    { "name": "Calendar", "description": "Cal.com integration" },
    { "name": "Contacts", "description": "Contact management" }
  ]
}
