#!/bin/bash
# Git pre-commit hook to prevent common mistakes
# Install: ln -s ../../.githooks/pre-commit .git/hooks/pre-commit

set -e

echo "ğŸ” Running pre-commit checks..."

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track if any checks failed
FAILED=0

# Get list of Python files being committed
PYTHON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

if [ -n "$PYTHON_FILES" ]; then
    echo ""
    echo "ğŸ“ Checking Python files..."

    for file in $PYTHON_FILES; do
        echo "  â†’ $file"

        # Check for local imports (indented import statements)
        INDENTED_IMPORTS=$(grep -n "^[[:space:]]\+import " "$file" || true)

        if [ -n "$INDENTED_IMPORTS" ]; then
            echo -e "${RED}âŒ FORBIDDEN: Local imports found in $file${NC}"
            echo ""
            echo "$INDENTED_IMPORTS"
            echo ""
            echo -e "${YELLOW}All imports MUST be at module top (no indentation).${NC}"
            echo -e "${YELLOW}Move these imports to the top of the file.${NC}"
            echo ""
            FAILED=1
        fi

        # Check for basic Python syntax errors
        if ! python3 -m py_compile "$file" 2>/dev/null; then
            echo -e "${RED}âŒ SYNTAX ERROR in $file${NC}"
            python3 -m py_compile "$file"
            FAILED=1
        fi
    done
fi

# Get list of JavaScript/TypeScript files being committed
JS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|ts|jsx|tsx)$' || true)

if [ -n "$JS_FILES" ]; then
    echo ""
    echo "ğŸ“ Checking JavaScript/TypeScript files..."

    for file in $JS_FILES; do
        echo "  â†’ $file"

        # Check for console.log statements (should use proper logging)
        # Uncomment if you want to enforce this:
        # CONSOLE_LOGS=$(grep -n "console\.log" "$file" || true)
        # if [ -n "$CONSOLE_LOGS" ]; then
        #     echo -e "${YELLOW}âš ï¸  WARNING: console.log found in $file${NC}"
        #     echo "  Consider using proper logging instead"
        # fi
    done
fi

echo ""

if [ $FAILED -eq 1 ]; then
    echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${RED}â•‘                                                â•‘${NC}"
    echo -e "${RED}â•‘  âŒ PRE-COMMIT CHECKS FAILED                   â•‘${NC}"
    echo -e "${RED}â•‘                                                â•‘${NC}"
    echo -e "${RED}â•‘  Fix the errors above and try again.           â•‘${NC}"
    echo -e "${RED}â•‘                                                â•‘${NC}"
    echo -e "${RED}â•‘  See PRE-COMMIT-CHECKLIST.md for details.      â•‘${NC}"
    echo -e "${RED}â•‘                                                â•‘${NC}"
    echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    exit 1
fi

echo -e "${GREEN}âœ… All pre-commit checks passed!${NC}"
echo ""

# Remind about testing
echo -e "${YELLOW}âš ï¸  REMINDER: Have you tested the affected features?${NC}"
echo -e "${YELLOW}   See PRE-COMMIT-CHECKLIST.md section 3${NC}"
echo ""

exit 0
